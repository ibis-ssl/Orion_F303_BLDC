# Orion_F303_BLDC 改善方針（性能重視）

## 目的
- 可読性・保守性を上げる。
- リアルタイム制御性能を維持する。
- 明らかな実行時間増加を避ける。

## 前提
- 対象は STM32F303（Cortex-M4F）専用実装。
- 制御周期は 1kHz 系のタイミング制約がある。
- 可搬性より実行性能を優先する。

## 基本方針
- 「挙動を変えない整理」と「挙動を変える改善」を分離する。
- 1 回の変更量を小さくし、毎回計測で性能退行を確認する。
- 速度クリティカル区間（ISR 周辺）は最小限の処理に限定する。

## 性能ガードレール
- 変更前に以下を計測し、基準値を保存する。
  - `interrupt_timer_cnt`
  - `task_complete_timer_cnt`
  - `main_loop_remain_counter`
- 変更後は同条件で再計測し、以下を満たすこと。
  - 最悪値が悪化しない（許容しても微小差のみ）
  - 平均値が実用上同等
  - 制御周期逸脱（デッドライン超過）が発生しない

## 段階的リファクタ手順
1. 計測基準の固定
- 現状コードで性能ログを取得し、比較用ベースラインを確定する。

2. ファイル分割（ロジック変更なし）
- 役割を分離する。
  - `fast path`: 割り込み内のセンサ更新・角度更新・PWM反映
  - `slow path`: CAN/UART/保護/キャリブレーション制御
- まずは移動のみ。式や条件は変えない。

3. 状態管理の明示化
- `run / enc_calib / motor_calib / fault` を状態として定義し、遷移を一元化する。
- 散在したフラグ判定を削減し、見通しを改善する。

4. データ構造の整理
- 関連するグローバル変数をコンテキスト構造体へ集約する。
- 依存関係を関数引数で明示し、影響範囲を小さくする。

5. 必要な範囲だけ最適化
- ISR 内の重い処理（可変長処理、不要分岐、ログ出力）を排除する。
- LUT・`inline`・定数化など既存の高速化方針を維持する。

## 実装ルール
- 速度クリティカル区間での `printf` 相当処理は禁止。
- マジックナンバーは用途名付き定数へ置換する。
- 1 変更 = 1 意図にし、レビュー可能な差分に分割する。
- 各 `.c` ファイル先頭に「責務コメント」を記載し、役割境界を明確化する。

## 受け入れ条件
- 既存機能（通常運転、CAN制御、保護、校正）が維持される。
- ベースライン比較で性能退行がない。
- 新規追加の構造（状態・責務分離）を他開発者が追える。

## 非目標（この段階では実施しない）
- 全面的なアルゴリズム変更（制御理論の刷新）
- 大規模な固定小数点化
- 移植性向上を目的とした抽象化の過剰導入
